on:
  schedule:
    # run every 40th minute of every hour
    - cron:  '0 14 * * 1'
  workflow_dispatch:

jobs:
  archive-channels:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        channel: [UCrIAnDo3VuWex3fywkGpB1g, UC55-bp-O5712zdlbU40sL4g, UCwiozDEiGSwecls_q_5qIYw, ExperienceLG, LGCanada, LGBlogFR, LGspain, LGlifesgoodPortugal, LGItalia, LGElectronicsAustria, LGMagyarorszag, LGHrvatska, LGSrbija, LGBulgaria, lghellas, lgexplore, lgczech, LGElectronics, LGMobileHQ, UCAxuf-vrbVcjqnMXL4bccgA,  UCTRwWQh2agj17vllx9Xc72Q, UCp481MCNVXV3CfmmI_oUq8w, UCjutSCve0ROVkHX9MTFgkvg,  UCLOfTxvgf3gmHzA6QRpYIJQ, LGSAE, lgmobileindonesia, LGUSAMobile, theofficalLGgirl, LGMobileVietnam, lifesgoodlab, LGteamcanada, lgbaltic, UCQU4jEAKdefoyIe5rIrxRnw, UCOW2PJwM9q7S4_ovC6oYUSA, LGNordic, LGElectronicsSG, lgemalaysia, lgthaicompany, LgCinema3DVietnam, UCQD46PPrjPz_YYyIx1E-ALw, LGHongKong, myLifesGoodPH, LGEjapan, lgheindonesia, LGAustralia, LGIndiachannel, LGElectronicsKZ, LGGulf, LGLevant, LGEIsreal, UCe8483ebklFn9miAzsbQ70g, UCrh0Gx-DI66rpaHNrqiamNQ, LGAfrica, UCIFjeVo9mweM5ji-O_9AF5A, UCJUs_qeJG8CL5vpNpEG5hTg, UC_XQ4FJYRo1xV7lh_4gcBCA, UCMjgKhrcE9YCNQngW1mxotA, UCBxb87-FfN-ekw-lMrFbrfA, LGSouthAfrica, LgElectronicsAr,  ExperienciasLG, LGEcuador, LGUkraine, livingLGvideo, LGCOLchannel, UC_XQ4FJYRo1xV7lh_4gcBCA]
    steps:
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install yt-dlp internetarchive tubeup
          mkdir -p ~/.tubeup
      - uses: actions/cache@v3
        id: cache
        with:
          path: '~/.tubeup'
          key: ${{ matrix.channel }}

      - name: Download and upload channel videos
        env: 
          IA_EMAIL: ${{ secrets.IA_EMAIL }}
          IA_PASSWORD: ${{ secrets.IA_PASSWORD }}
        run: |
          ia configure --username="$IA_EMAIL" --password="$IA_PASSWORD"   
          yt-dlp -j --datebefore 20180101 --no-warnings --playlist-reverse --flat-playlist "https://youtube.com/c/${{ matrix.channel }}" "https://youtube.com/channel/${{ matrix.channel }}" "https://youtube.com/user/${{ matrix.channel }}" | jq -r ".urls" > result.log
          while IFS="" read -r p || [ -n "$p" ]
          do
            tubeup $p --get-comments --use-download-archive || true
          done < result.log
          
      
      - name: Get sha1 of .ytdlarchive
        id: sha1
        run: |
          export BRAP=$(cat ~/.tubeup/.ytdlarchive | shasum - | head -c 40)
          echo '::set-output name=sha1::$BRAP'
